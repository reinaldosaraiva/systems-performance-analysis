# ü§ñ Integra√ß√£o LLM com Grafana - Guia Completo

## ‚úÖ Status: API Server Pronto

**Endpoints LLM dispon√≠veis:**
- üé® Dashboard HTML: `http://localhost:8080/dashboard/llm`
- üîç API Insights: `http://localhost:8080/api/insights/llm`

---

## üìã Passo-a-Passo: Adicionar Painel LLM no Grafana

### 1Ô∏è‚É£ Acessar o Dashboard do Grafana

1. Abra o Grafana: `http://localhost:3000`
2. Login: `admin` / `admin123`
3. Navegue para o dashboard **"Unified USE Method"** ou qualquer outro que deseja adicionar o painel

### 2Ô∏è‚É£ Adicionar Novo Painel

1. Clique em **"Add"** (√≠cone +) no topo direito
2. Selecione **"Add panel"**
3. Na lista de visualiza√ß√µes, escolha **"Text"**

### 3Ô∏è‚É£ Configurar o Painel

**Modo de Edi√ß√£o:**
1. No campo de texto, **altere de "Markdown" para "HTML"** (dropdown no topo)
2. Cole o seguinte c√≥digo HTML:

```html
<iframe
    src="http://localhost:8080/dashboard/llm"
    width="100%"
    height="800px"
    frameborder="0"
    style="border: none; overflow: hidden;">
</iframe>
```

**Configura√ß√µes do Painel:**
1. **Panel Title:** "ü§ñ LLM-Powered Performance Analysis"
2. **Description:** "Intelligent insights generated by MiniMax-M2 (230B parameters)"
3. **Transparent background:** Ativado (opcional)

### 4Ô∏è‚É£ Ajustar Tamanho

1. Clique em **"Apply"** para salvar
2. Redimensione o painel arrastando os cantos
3. Sugest√£o: Largura completa (12 colunas) x Altura 800-1000px

### 5Ô∏è‚É£ Salvar Dashboard

1. Clique no √≠cone de **"Save dashboard"** (üíæ) no topo
2. Adicione nota: "Added LLM-powered insights panel"
3. Clique em **"Save"**

---

## üé® Layout Recomendado

### Op√ß√£o A: Dashboard Separado (Recomendado)
Crie um dashboard exclusivo para an√°lise LLM:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ü§ñ LLM-Powered Performance Analysis         ‚îÇ
‚îÇ (Dashboard dedicado)                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Como criar:**
1. Dashboard ‚Üí New Dashboard
2. Add ‚Üí Text (HTML mode)
3. Cole o iframe acima
4. Save as "LLM Performance Analysis"

### Op√ß√£o B: Integrado ao USE Method Dashboard
Adicione como √∫ltima se√ß√£o do dashboard existente:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ USE Method Metrics (Prometheus)             ‚îÇ
‚îÇ ‚îú‚îÄ CPU Utilization                          ‚îÇ
‚îÇ ‚îú‚îÄ Memory Usage                             ‚îÇ
‚îÇ ‚îî‚îÄ Network/Disk                             ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ üìä Rule-Based Insights                      ‚îÇ
‚îÇ (http://localhost:8080/dashboard)           ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ ü§ñ LLM-Powered Insights ‚≠ê NOVO!            ‚îÇ
‚îÇ (http://localhost:8080/dashboard/llm)       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üîß Troubleshooting

### Problema: "Refused to display in a frame"
**Solu√ß√£o:** J√° configurado! O `GF_PANELS_DISABLE_SANITIZE_HTML=true` est√° no docker-compose.yml

Verifique se est√° ativo:
```bash
docker exec grafana env | grep SANITIZE
# Deve retornar: GF_PANELS_DISABLE_SANITIZE_HTML=true
```

### Problema: Dashboard vazio ou "Loading..."
**Poss√≠veis causas:**
1. **Ollama n√£o est√° rodando:**
   ```bash
   curl http://localhost:11434/api/tags
   ```

2. **Modelo MiniMax-M2 n√£o instalado:**
   ```bash
   ollama list | grep minimax
   ```

3. **API server n√£o est√° rodando:**
   ```bash
   curl http://localhost:8080/health
   ```

4. **Prometheus inacess√≠vel:**
   ```bash
   curl http://177.93.132.48:9090/api/v1/query?query=up
   ```

### Problema: "Error: LLM analysis failed"
**Ver logs:**
```bash
tail -f /tmp/brendan_api.log
```

**Solu√ß√µes:**
- Verificar se Ollama est√° rodando: `ollama list`
- Verificar m√©tricas Prometheus: `curl http://177.93.132.48:9090/api/v1/query?query=node_load1`
- Reiniciar API server: `pkill -f brendan_api_server && uv run python src/brendan_api_server.py &`

---

## üöÄ Testando Antes de Adicionar ao Grafana

### Teste 1: Abrir no Navegador
```
http://localhost:8080/dashboard/llm
```

**Esperado:**
- Header roxo com "ü§ñ LLM-Powered Performance Analysis"
- Spinner de loading por 30-60 segundos
- Insights renderizados com cards coloridos

### Teste 2: Verificar API JSON
```bash
curl http://localhost:8080/api/insights/llm | jq
```

**Esperado:**
```json
{
  "source": "llm",
  "model": "minimax-m2:cloud",
  "total": 5,
  "insights": [...]
}
```

### Teste 3: Verificar Tempo de Resposta
```bash
time curl -s http://localhost:8080/api/insights/llm > /dev/null
```

**Esperado:** ~30-60 segundos

---

## üìä Compara√ß√£o: Rule-Based vs LLM

### Dashboard Rule-Based (`/dashboard`)
- ‚ö° R√°pido: < 1 segundo
- üìä Dados diretos de validation reports
- üéØ Insights b√°sicos baseados em thresholds

### Dashboard LLM (`/dashboard/llm`) ‚≠ê
- ü§ñ Inteligente: An√°lise com LLM 230B par√¢metros
- ‚è±Ô∏è Mais lento: 30-60 segundos
- üí° Insights contextuais e profundos
- üìñ Linguagem natural fluente
- üîó Relaciona m√∫ltiplas m√©tricas

**Recomenda√ß√£o:** Use ambos!
- Rule-based para monitoramento cont√≠nuo
- LLM para investiga√ß√£o profunda de problemas

---

## üéØ Exemplo de Visualiza√ß√£o

Quando o painel LLM carregar, voc√™ ver√°:

### Header
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ü§ñ LLM-Powered Performance Analysis      ‚îÇ
‚îÇ Intelligent insights by MiniMax-M2       ‚îÇ
‚îÇ (230B parameters)                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Stats Cards
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  5   ‚îÇ  1   ‚îÇ  2   ‚îÇ  ‚úì   ‚îÇ
‚îÇTotal ‚îÇCrit  ‚îÇHigh  ‚îÇStatus‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Insight Card Exemplo
```
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë CPU Near Saturation                  HIGH ‚ïë
‚ïü‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ï¢
‚ïë üìä Observation                            ‚ïë
‚ïë CPU utilization is at 88.72% with load   ‚ïë
‚ïë average of 21.09 on 8-core system...     ‚ïë
‚ïë                                           ‚ïë
‚ïë üéØ Root Cause                             ‚ïë
‚ïë The load per CPU of 2.64 means           ‚ïë
‚ïë approximately 2.64 processes competing... ‚ïë
‚ïë                                           ‚ïë
‚ïë ‚ö° Immediate Action                       ‚ïë
‚ïë Run `top` to identify the top CPU        ‚ïë
‚ïë consuming processes...                    ‚ïë
‚ïë                                           ‚ïë
‚ïë üîç Investigation Steps                    ‚ïë
‚ïë 1. Run mpstat -P ALL 1                   ‚ïë
‚ïë 2. Check with perf top                   ‚ïë
‚ïë 3. Review application logs               ‚ïë
‚ïë                                           ‚ïë
‚ïë üí° Long-term Fix                          ‚ïë
‚ïë Optimize hot code paths or scale         ‚ïë
‚ïë horizontally...                           ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
```

---

## üîÑ Auto-Refresh

O dashboard LLM tem **auto-refresh de 5 minutos**:
- Primeira an√°lise: Ao carregar a p√°gina
- Pr√≥ximas: A cada 5 minutos automaticamente
- Motivo: LLM analysis leva 30-60s, n√£o faz sentido refresh muito frequente

Se quiser alterar:
```javascript
// Linha 742-743 em src/brendan_api_server.py
setInterval(loadLLMInsights, 300000);  // 5 min (padr√£o)
// Altere para:
setInterval(loadLLMInsights, 180000);  // 3 min
setInterval(loadLLMInsights, 600000);  // 10 min
```

---

## üí° Dicas Pro

### 1. Dashboard Combinado
Crie um dashboard com 3 pain√©is:
1. **M√©tricas USE Method** (Prometheus)
2. **Insights Rule-Based** (iframe para `/dashboard`)
3. **Insights LLM** (iframe para `/dashboard/llm`)

### 2. Refresh Inteligente
Configure refresh do Grafana para **5 minutos** no dashboard LLM:
- Clique em ‚öôÔ∏è (Dashboard settings)
- Auto Refresh ‚Üí Adicione "5m"

### 3. Vari√°veis Grafana
Adicione vari√°vel para alternar entre an√°lises:
```
analysis_type: rule-based | llm
URL: http://localhost:8080/dashboard/${analysis_type}
```

### 4. Alertas
Configure alertas para quando LLM detectar CRITICAL:
- Use Grafana Alerting com JSON API data source
- Query: `http://localhost:8080/api/insights/llm`
- Condi√ß√£o: `total_critical > 0`

---

## üìÅ Arquivos Relacionados

- **API Server:** `src/brendan_api_server.py`
- **LLM Agent:** `src/brendan_llm_agent.py`
- **Docker Compose:** `docker-compose.yml`
- **Tests:** `examples/test_brendan_llm.py`

---

## ‚úÖ Checklist Final

Antes de usar no Grafana, verifique:

- [ ] Ollama rodando: `curl http://localhost:11434/api/tags`
- [ ] Modelo instalado: `ollama list | grep minimax`
- [ ] API server rodando: `curl http://localhost:8080/health`
- [ ] Prometheus acess√≠vel: `curl http://177.93.132.48:9090/api/v1/query?query=up`
- [ ] Dashboard carrega: Abrir `http://localhost:8080/dashboard/llm` no browser
- [ ] Grafana permite HTML: `docker exec grafana env | grep SANITIZE`

---

**Pronto para adicionar no Grafana!** üéâ

Siga o passo-a-passo acima e voc√™ ter√° an√°lise LLM integrada ao seu dashboard de performance.
